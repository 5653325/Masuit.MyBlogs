@using CacheManager.Core
@implements IDisposable
@inject ICacheManager<uint> CacheManager

<span class="text-red">@online</span>人正在浏览本文

@code {
    [Parameter]
    public int Id { get; set; }
    bool flag;
    uint online;

    protected override void OnInitialized()
    {
        online = CacheManager.AddOrUpdate("postOnline:" + Id, 1u, i => i + 1);
        flag = true;
        Task.Run(async () =>
        {
            while (flag)
            {
                online = CacheManager.Get("postOnline:" + Id);
                await InvokeAsync(StateHasChanged);
                await Task.Delay(2000);
            }
        });
    }

    /// <summary>执行与释放或重置非托管资源关联的应用程序定义的任务。</summary>
    public void Dispose()
    {
        flag = false;
        online = CacheManager.AddOrUpdate("postOnline:" + Id, 1u, i =>
        {
            try
            {
                checked
                {
                    return i - 1;
                }
            }
            catch
            {
                return 0;
            }
        });
    }
}
